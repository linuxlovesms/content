{name}Wilson Vargas{/name}{company}Microsoft{/company}{title}Использование собственного образа операционной системы FreeBSD на платформе Azure{/title}{cat}0{/cat}{date}30.03.2016{/date}{desc}Представляем вашему вниманию статью о запуске FreeBSD в Azure{/desc}

Есть 2 способа запустить FreeBSD в Azure. Первый – взять готовый образ из хранилища шаблонов виртуальных машин Azure VMdepot, второй - подготовить собственный образ. Если по каким-либо причинам готовый образ вас не устраивает, и вы хотите подготовить собственный, тогда эта статья вам поможет. 

##Создание образа системы FreeBSD
Сначала мы рассмотрим вопрос подготовки образа системы FreeBSD x86_64 10 для платформы Microsoft Azure. В самом начале мы должны произвести локальную установку операционной системы FreeBSD с использованием системы аппаратной визуализации Hyper-V (если возможно, с использованием Windows Server 2012 R2). Для того чтобы облегчить выполнение этой задачи, энтузиасты системы FreeBSD создали образы формата VHD, содержащие предустановленную систему FreeBSD. 

- Воспользуйтесь ссылкой [ftp://ftp.freebsd.org/pub/FreeBSD/snapshots/VM-IMAGES/10.0-RELEASE/amd64/Latest/](ftp://ftp.freebsd.org/) и загрузите последнюю версию файла. Например, файл Vhd.xz можно найти здесь: [ftp://ftp.freebsd.org/pub/FreeBSD/snapshots/VM-IMAGES/10.0-RELEASE/amd64/Latest/FreeBSD-10.0-RELEASE-amd64-20140116-r260789.vhd.xz](ftp://ftp.freebsd.org/pub/FreeBSD/snapshots/VM-IMAGES/10.0-RELEASE/amd64/Latest/FreeBSD-10.0-RELEASE-amd64-20140116-r260789.vhd.xz)
- Теперь распакуйте файл с расширением *.xz, после чего вы получите файл FreeBSD-10.0-RELEASE-amd64- * формата VHD. Указанную операцию можно выполнить с использованием нескольких архиваторов. Я обычно использую [7-zip](http://www.7-zip.org/).
- Создайте новую виртуальную машину в системе Hyper-V и подключите распакованный файл формата VHD в качестве IDE-диска:

![pic1](https://c.s-microsoft.com/ru-ru/CMSImages/bsd-2.png?version=2cfe5420-2cef-73c7-b4c8-7fc798291e51)

###Настройте размер файла системы FreeBSD в формате VHD (при необходимости).
Если вы решили устанавливать систему FreeBSD на виртуальную машину Hyper-V "с нуля", с использованием установочного ISO-образа, тогда вы можете пропустить эту операцию. 

Однако при использовании предварительно сгенерированного виртуального жесткого диска с сайта [ftp.freebsd.org](ftp://ftp.freebsd.org/) вам, возможно, придется изменить размер вашего виртуального жесткого диска, чтобы обеспечить совместимость с платформой Azure. При создании виртуального жесткого диска на платформе Azure размер этого диска должен представлять собой целое число в мегабайтах (МБ), иначе при попытке создания нового образа системы FreeBSD вы получите от сервиса Azure следующее сообщение об ошибке: 

`“The VHD http://<tucuenta>.blob.core.windows.net/vhds/FreeBSD-10.0-RELEASE-amd64-20140116-r260789.vhd has an unsupported virtual size of 21475270656 bytes. The size must be a whole number (in MBs).”`

В загруженном нами образе системы FreeBSD 21475270656 байт фактически равны 20480,4140625 МБ. Итак, для того чтобы исправить это несоответствие, просто измените размер вашего виртуального жесткого диска таким образом, чтобы он не превышал 21000 МБ. Если вам нравится работать с консолями, вы можете выбрать для этих целей консоль управления Powershell или Hyper-V. В сервере Hyper-V открываете систему команд PowerShell и запускаете команду Resize-VHD для изменения размера виртуального жесткого диска (VHD): 

![pic2](https://c.s-microsoft.com/ru-ru/CMSImages/bsd-3.png?version=9928d808-c445-664a-1a59-24564ca5d143)

Вы также можете изменить размер вашего диска с использованием консоли управления Hyper-V. В меню настроек вашей виртуальной машины (в данном случае, FreeBSD) щелкните пункт "virtual IDE drive" ("виртуальный IDE-диск"), затем щелкните кнопку "Edit" ("Редактирование"), чтобы открыть помощник-редактор параметров VHD: 

![pic3](https://c.s-microsoft.com/ru-ru/CMSImages/bsd-4.png?version=18fd6757-e227-f423-93cd-7cde01c1b603)

Затем запустите систему FreeBSD и войдите в систему в качестве суперпользователя. Пользователи системы не сгенерировали ранее пароля суперпользователя на жестком диске, поэтому вход будет осуществляться без пароля. После входа в систему запустите команду gpart и выполните поиск разделов диска. Вы можете видеть, что диску da0 присвоен ярлык CORRUPT, т.к. мы ранее изменили размер нашего виртуального жесткого диска: 

![pic4](https://c.s-microsoft.com/ru-ru/CMSImages/bsd-5.png?version=4d947a4a-dab7-43cd-59a1-ce41dfcc6a03)

Не беспокойтесь. Чтобы исправить диск da0, просто запустите следующую команду: 

![pic5](https://c.s-microsoft.com/ru-ru/CMSImages/bsd-6.png?version=5768481f-c206-5f26-c2f8-ecf4dd5fbc28)

В качестве варианта, вы можете попробовать изменить размер корневого раздела FreeBSD, что позволит вам вернуть утраченное свободное место. 

Для того чтобы изменить размер корневой файловой системы, придется повозиться; возможно, вам придется загрузиться с использованием загрузочного диска системы FreeBSD. Но если вы действительно хотите вернуть себе утраченное свободное место на диске, расширить корневую файловую систему можно следующим образом: 

![pic6](https://c.s-microsoft.com/ru-ru/CMSImages/bsd-7.png?version=efc8924d-2d79-61fa-f92b-02bbb826d303)

Отлично! Наш виртуальный жесткий диск готов к использованию, и мы также теперь готовы к подготовке нашей системы FreeBSD к ее использованию на платформе Azure. 

###Подготовка операционной системы FreeBSD к использованию на платформе Azure
Теперь все будет просто (не сомневайтесь!) Нам нужно просто установить несколько дополнительных компонентов и настроить несколько параметров, и система FreeBSD 10 будет готова к работе в Azure. 

- **Разрешите использование сетей системой FreeBSD**

Для настройки интерфейса hn0 вы можете использовать команду `/etc/rc.d/ netif `(обеспечивает запуск и останов функциональности Net): 

![pic7](https://c.s-microsoft.com/ru-ru/CMSImages/bsd-8.png?version=d8f124ca-9218-70ea-2b60-6616040da8f3)

- **Разрешите использование SSH-аутентификации**

Для этого вам нужно сначала запустить управляющую программу SSH с использованием пути /etc/rc.conf и создать новые хост-ключи: 

![pic8](https://c.s-microsoft.com/ru-ru/CMSImages/bsd-9.png?version=6a77744f-e065-4c65-850e-c6f1ab78627e)

Заметьте, что если вы захотите использовать эти данные SSH-аутентификации для другого пользователя-гостя системы FreeBSD, вы можете продолжать использовать эту конфигурацию, но вам придется создать нового пользователя без привилегий (рекомендуется) или задать пароль суперпользователя и задать параметр "PermitRootLogin yes" в пути / etc / ssh / sshd_config (не рекомендуется). 

- **Установка языка Python 2.7 и соответствующих модулей:**

![pic9](https://c.s-microsoft.com/ru-ru/CMSImages/bsd-10.png?version=02e00b80-747f-dc93-7cf7-b72694dc0528)

Вам может также понадобиться создать символьную ссылку на новые двоичные файлы python 2.7, находящиеся по адресу / usr / bin / python. Это можно сделать следующим образом: 

![pic10](https://c.s-microsoft.com/ru-ru/CMSImages/bsd-11.png?version=47439192-f1d4-28c9-433a-158a0ed29047)

- **Установка утилиты sudo**

Это необходимо сделать потому, что, как правило, учетная запись суперпользователя деактивируется сервисом Azure, и для запуска команд с высоким классом привилегий мы будем использовать утилиту sudo от имени непривилегированного пользователя: 

![pic11](https://c.s-microsoft.com/ru-ru/CMSImages/bsd-13.png?version=22fc1f8b-4a29-c9df-2de9-7081ee45c5d5)

- **Установка приложения Azure Linux Agent**

Последнюю версию приложения Azure Linux Agent всегда можно найти на сайте Github: [https://github.com/Azure/WALinuxAgent/releases](https://github.com/Azure/WALinuxAgent/releases). Для использования в системе FreeBSD рекомендуется версия 2.0.5 или более новая. Однако, как правило, большой стабильностью работы отличается ветвь программы 2.0, поэтому в данный момент мы просто перейдем прямо к этой ветви. Это позволит нам воспользоваться наиболее эффективным агентом с поддержкой системы FreeBSD: 

![pic12](https://c.s-microsoft.com/ru-ru/CMSImages/bsd-13.png?version=22fc1f8b-4a29-c9df-2de9-7081ee45c5d5)
![pic13](https://c.s-microsoft.com/ru-ru/CMSImages/bsd-14.png?version=d3fe7b51-1842-ae3b-6c85-f2ec6850aaee)
![pic14](https://c.s-microsoft.com/ru-ru/CMSImages/bsd-15.png?version=da83b21b-23f8-dd0b-9255-3c53f69ca908)

Агент Azure установлен и работает! 

- **(Опционально) Генерализация системы перед загрузкой виртуального диска (VHD) на платформе Azure**

Данная функция позволит обобщить параметры образа. В результате должны быть исключены SSH-сертификаты, деактивирован доступ суперпользователя и удален соответствующий пароль, удалены кэшированные элементы протокола DHCP и т.д. Это – хорошая практика; однако если вы не планируете обеспечить широкий публичный доступ к данному виртуальному жесткому диску, вы можете пропустить данный шаг: 

![pic15](https://c.s-microsoft.com/ru-ru/CMSImages/bsd-16.png?version=1fcca78a-fed4-733d-6bb6-f9aecde2ee7b)

**Примечание** : После запуска этой команды может появиться предупреждающее сообщение, потому что файл OVF-env.xml не существует. Вы можете оставить это сообщение "как есть", иными словами, просто проигнорировать его. 

- **Выключение виртуальной машины FreeBSD**

Все готово! И проще не бывает, не правда ли? 

- **Выгрузка виртуального жесткого диска FreeBSD на платформу Azure**

Выгрузить виртуальный жесткий диск на платформу Azure можно несколькими способами. В этой статье мы воспользуемся инструментами Azure PowerShell для подключения виртуального жесткого диска к нашей учетной записи хранения: 

Прежде всего, убедитесь в том, что виртуальная машина FreeBSD на вашем сервере Hyper-V выключена. 

Затем для загрузки виртуального жесткого диска воспользуйтесь командой Add-AzureVhd: 

![pic16](https://c.s-microsoft.com/ru-ru/CMSImages/bsd-17.png?version=a14a0d61-16bf-9da6-0a1b-9e2df22bbb8f)
![pic17](https://c.s-microsoft.com/ru-ru/CMSImages/bsd-18.png?version=cf1f4932-7264-14e7-ef58-faadc7a7a302)

После того как загрузка будет завершена, вы можете воспользоваться виртуальным жестким диском для создания образа и предусмотреть при этом возможность использования любого количества виртуальных машин FreeBSD в среде Azure: 

![pic18](https://c.s-microsoft.com/ru-ru/CMSImages/bsd-19.png?version=b1acc858-2f79-df78-1262-f178f7b3aa5a)

Заметьте, что здесь вам придется использовать операционную систему Linux. К сожалению, инструменты Powershell еще не поддерживают работу с параметром "-SO FreeBSD" 

##Создание виртуальной машины FreeBSD на платформе Azure

Наконец, мы готовы к созданию наших виртуальных машин FreeBSD на платформе Azure. Вы можете использовать инструменты PowerShell или же выполнять все операции на портале: 

Выполните вход в Портал управления Azure ("Azure Management Portal") ([https://manage.windowsazure.com](https://manage.windowsazure.com/))	и выберите пункты меню "New -> COMPUTE -> VIRTUAL Machine -> FROM GALLERY " ("Новый -> РАСЧЕТ -> ВИРТУАЛЬНАЯ машина -> ИЗ ГАЛЕРЕИ") 

![pic19](https://c.s-microsoft.com/ru-ru/CMSImages/bsd-20.png?version=63811b57-6ea3-3ba6-df6f-4c3bba60e216)

Щелкните пункт меню "My Images" ("Мои образы") и выберите ваш образ 

![pic20](https://c.s-microsoft.com/ru-ru/CMSImages/bsd-21.png?version=a7b3045b-d54d-d387-b98e-6f2d1b500407)

Выберите ваш образ операционной системы FreeBSD и выполняйте появляющиеся на экране указания для задания пароля / имени хоста, параметров SSH и т.д. Как только вы завершите этот процесс, вы окажетесь счастливым владельцем новенькой виртуальной машины FreeBSD 10, работающей на платформе Azure.
